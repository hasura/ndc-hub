services:
  phoenix-hbase:
    image: boostport/hbase-phoenix-all-in-one:2.0-5.0
    ports:
      - "8765:8765"    # Phoenix Query Server
      - "16010:16010"  # HBase Master Web UI
      - "16020:16020"  # HBase RegionServer Web UI
      - "2181:2181"    # ZooKeeper
    environment:
      PHOENIX_OPTS: "-Dphoenix.schema.isNamespaceMappingEnabled=true"
    volumes:
      - hbase_data:/tmp
      - ./configure-hbase.sh:/opt/configure-hbase.sh
    command: |
      sh -c "
        chmod +x /opt/configure-hbase.sh &&
        /opt/configure-hbase.sh &&
        echo 'Starting HBase in standalone mode...' &&
        /opt/hbase/bin/start-hbase.sh &&
        echo 'Starting Phoenix Query Server...' &&
        /opt/phoenix-server/bin/queryserver.py &
        echo 'Phoenix setup complete. Services running...' &&
        tail -f /dev/null
      "
    healthcheck:
      test: ["CMD", "bash", "-c", "curl -f http://localhost:8765 || exit 0"]
      interval: 45s
      timeout: 30s
      retries: 20
      start_period: 300s

volumes:
  hbase_data: