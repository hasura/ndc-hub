name: Test DDN Workspace with Connectors

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches: [main]
    paths:
      - registry/**

jobs:
  setup-connector-tests:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.connector-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get all connector version package changes
        id: connector-version-changed-files
        uses: tj-actions/changed-files@v46.0.1
        with:
          json: true
          escape_json: false
          files: |
            registry/**

      - name: Print out all the changed files
        env:
          ADDED_FILES: ${{ steps.connector-version-changed-files.outputs.added_files }}
          MODIFIED_FILES: ${{ steps.connector-version-changed-files.outputs.modified_files }}
          DELETED_FILES: ${{ steps.connector-version-changed-files.outputs.deleted_files }}
        run: |
          echo "{\"added_files\": $ADDED_FILES, \"modified_files\": $MODIFIED_FILES, \"deleted_files\": $DELETED_FILES}" > changed_files.json
          cat changed_files.json

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21.x

      - name: Get the list of connectors to test
        id: connector-matrix
        env:
          CHANGED_FILES_PATH: "changed_files.json"
        run: |
          mv changed_files.json registry-automation/changed_files.json
          export NDC_HUB_GIT_REPO_FILE_PATH=$(pwd)
          cd registry-automation
          MATRIX_JSON=$(go run main.go e2e changed)
          echo "$MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

      - name: Check if connector is published to staging
        run: |
          LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
          REQUIRED_LABEL="connector-staging-deploy-success"
          if echo "$LABELS" | jq -e 'contains(["'"$REQUIRED_LABEL"'"])' > /dev/null; then
            echo "âœ… Connector published to staging!"
          else
            echo "âŒ Error: Connector is not yet published to staging."
            echo "This job will automatically run again once the connector is published to staging."
            exit 1
          fi

  build-ddn-workspace:
    needs: setup-connector-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate connector version overrides
        id: connector-overrides
        run: |
          set -e
          
          echo "ðŸ” Generating connector version overrides for changed connectors"
          
          # Parse the test matrix to get connector details
          MATRIX='${{ needs.setup-connector-tests.outputs.matrix }}'
          echo "Test matrix: $MATRIX"
          
          # Create connector versions JSON file
          echo "{}" > connector-versions.json
          
          # Process each connector in the matrix and update versions
          echo "$MATRIX" | jq -c '.[]' | while IFS= read -r connector_info; do
            CONNECTOR_NAME=$(echo "$connector_info" | jq -r '.connector_name')
            CONNECTOR_VERSION=$(echo "$connector_info" | jq -r '.connector_version')
            NAMESPACE=$(echo "$connector_info" | jq -r '.namespace')
            
            echo "Processing connector: $NAMESPACE/$CONNECTOR_NAME:$CONNECTOR_VERSION"
            
            # Update the connector version in JSON file
            jq --arg key "$CONNECTOR_NAME" --arg val "$CONNECTOR_VERSION" '.[$key] = $val' connector-versions.json > connector-versions.tmp
            mv connector-versions.tmp connector-versions.json
          done
          
          echo "ðŸ“„ Generated connector versions file:"
          cat connector-versions.json

      - name: Build DDN Workspace with updated connector versions
        timeout-minutes: 20
        run: |
          set -e
          
          echo "ðŸš€ Building DDN Workspace with updated connector versions"
          
          # Check if connector versions file exists and has content
          if [ -f "connector-versions.json" ] && [ "$(jq 'keys | length' connector-versions.json)" -gt 0 ]; then
            echo "ðŸ“„ Using connector versions file:"
            cat connector-versions.json
            
            # Use the build script to build with custom versions
            cd ddn-workspace
            chmod +x scripts/build-with-versions.sh
            ./scripts/build-with-versions.sh ../connector-versions.json ddn-workspace:test
            cd ..
          else
            echo "Building with default connector versions..."
            DOCKER_BUILDKIT=0 docker build \
              -t ddn-workspace:test \
              -f ddn-workspace/Dockerfile \
              --no-cache \
              ./ddn-workspace
          fi

          echo "âœ… DDN Workspace built successfully"

      - name: Verify connector versions in workspace
        run: |
          set -e
          
          echo "ðŸ” Verifying connector versions in DDN workspace"
          
          # Start workspace temporarily to check versions
          docker run -d \
            --name ddn-version-check \
            --privileged \
            --entrypoint="" \
            ddn-workspace:test \
            bash -c "
              # Start Docker daemon
              dockerd --host=unix:///var/run/docker.sock &
              while ! docker info >/dev/null 2>&1; do sleep 1; done
              sleep 3600
            "
          
          sleep 10
          
          # Check which connector versions are available
          docker exec ddn-version-check bash -c '
            export PATH="$HOME/.local/bin:$PATH"
            echo "ðŸ“‹ Available connector versions:"
            show_supported_connector_versions.sh
          '
          
          # Stop the verification container
          docker stop ddn-version-check
          docker rm ddn-version-check
          
          echo "âœ… Connector version verification completed"

      - name: Test DDN Workspace basic functionality
        run: |
          set -e
          
          echo "ðŸ§ª Testing DDN Workspace basic functionality"
          
          # Start DDN workspace as a service container with Docker-in-Docker
          # Skip the entrypoint that requires supervisor and directly test DDN CLI
          docker run -d \
            --name ddn-workspace-test \
            --privileged \
            -e DDN_WORKSPACE_ACCESS_TOKEN=${{ secrets.HASURA_DDN_PAT }} \
            --entrypoint="" \
            ddn-workspace:test \
            bash -c "
              # Start Docker daemon in background
              dockerd --host=unix:///var/run/docker.sock --host=tcp://0.0.0.0:2376 &
              DOCKER_PID=\$!
              
              # Wait for Docker to be ready
              while ! docker info >/dev/null 2>&1; do sleep 1; done
              echo 'Docker daemon started'
              
              # Keep container running
              sleep 3600
            "
          
          # Wait for Docker daemon to start
          echo "â³ Waiting for Docker daemon to start..."
          sleep 15
          
          # Test that DDN CLI is working
          docker exec ddn-workspace-test bash -c '
            export PATH="$HOME/.local/bin:$PATH"
            ddn --version
            echo "âœ… DDN CLI working"
          '
          
          # Test DDN auth if token is provided
          docker exec ddn-workspace-test bash -c '
            export PATH="$HOME/.local/bin:$PATH"
            if [[ -n "$DDN_WORKSPACE_ACCESS_TOKEN" ]]; then
              ddn auth login --access-token "$DDN_WORKSPACE_ACCESS_TOKEN" || echo "DDN auth test completed"
            fi
          '
          
          # Stop and remove the test container
          docker stop ddn-workspace-test
          docker rm ddn-workspace-test
          
          echo "âœ… Basic functionality tests passed"

      - name: Save DDN Workspace image
        run: |
          # Save the image for connector tests
          docker save ddn-workspace:test | gzip > ddn-workspace.tar.gz
          
      - name: Upload DDN Workspace image
        uses: actions/upload-artifact@v4
        with:
          name: ddn-workspace-image
          path: ddn-workspace.tar.gz
          retention-days: 1

  test-connectors:
    needs: [setup-connector-tests, build-ddn-workspace]
    runs-on: ubuntu-latest
    environment: staging
    if: needs.build-ddn-workspace.result == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.4

      - name: Install dependencies
        working-directory: registry-automation/e2e-testing
        run: bun install

      - name: Download DDN Workspace image (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ddn-workspace-image

      - name: Load DDN Workspace image (if available)
        continue-on-error: true
        run: |
          if [ -f "ddn-workspace.tar.gz" ]; then
            docker load < ddn-workspace.tar.gz
            docker images | grep ddn-workspace
          else
            echo "No DDN workspace image artifact found"
          fi

      - name: Run DDN workspace tests
        timeout-minutes: 20
        env:
          HASURA_DDN_PAT: ${{ secrets.HASURA_DDN_PAT }}
          DDN_WORKSPACE_ACCESS_TOKEN: ${{ secrets.DDN_STAGING_PAT }}
        run: |
          set -e
          
          echo "ðŸ§ª Running DDN workspace connector tests"
          
          # Set up environment
          export NDC_HUB_GIT_REPO_FILE_PATH=$(pwd)
          
          # Parse the test matrix to get connector specifications
          MATRIX='${{ needs.setup-connector-tests.outputs.matrix }}'
          echo "Test matrix: $MATRIX"
          
          # Run tests for each connector using bun
          echo "$MATRIX" | jq -c '.[]' | while IFS= read -r connector_info; do
            CONNECTOR_NAME=$(echo "$connector_info" | jq -r '.connector_name')
            CONNECTOR_VERSION=$(echo "$connector_info" | jq -r '.connector_version')
            NAMESPACE=$(echo "$connector_info" | jq -r '.namespace')
            
            SPEC="$NAMESPACE/$CONNECTOR_NAME:$CONNECTOR_VERSION"
            echo "ðŸ” Testing connector: $SPEC"
            
            cd registry-automation/e2e-testing
            bun ddn-workspace-testing.ts "$SPEC"
            cd ../..
            
            echo "âœ… Completed testing: $SPEC"
          done
          
          echo "ðŸŽ‰ All DDN workspace tests completed successfully!"


