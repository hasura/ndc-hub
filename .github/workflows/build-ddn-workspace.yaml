name: Build and Push DDN Workspace

on:
  push:
    branches: ['**']  # Run on every commit to any branch
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode - hardcode connector changes and upload as artifact'
        required: false
        default: true
        type: boolean

jobs:
  detect-connector-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check-changes.outputs.should_build }}
      changed_connectors: ${{ steps.check-changes.outputs.changed_connectors }}
      connector_matrix: ${{ steps.check-changes.outputs.connector_matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get all connector version package changes
        id: connector-version-changed-files
        uses: tj-actions/changed-files@v46.0.1
        with:
          json: true
          escape_json: false
          files: |
            registry/**
            ddn-workspace/**

      - name: Print out all the changed files
        env:
          ADDED_FILES: ${{ steps.connector-version-changed-files.outputs.added_files }}
          MODIFIED_FILES: ${{ steps.connector-version-changed-files.outputs.modified_files }}
          DELETED_FILES: ${{ steps.connector-version-changed-files.outputs.deleted_files }}
        run: |
          echo "{\"added_files\": $ADDED_FILES, \"modified_files\": $MODIFIED_FILES, \"deleted_files\": $DELETED_FILES}" > changed_files.json
          cat changed_files.json

      - name: Check for connector changes
        id: check-changes
        env:
          CHANGED_FILES_PATH: "changed_files.json"
        run: |
          set -e

          # Check if this is a test mode (workflow dispatch OR push event for testing)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "changed_connectors=hasura/postgres:v3.1.0,hasura/snowflake-jdbc:v1.2.12" >> "$GITHUB_OUTPUT"

            # Create hardcoded test matrix
            TEST_MATRIX='[
              {"namespace": "hasura", "connector_name": "postgres", "connector_version": "v3.1.0"},
              {"namespace": "hasura", "connector_name": "snowflake-jdbc", "connector_version": "v1.2.12"}
            ]'
            echo "connector_matrix=$(echo "$TEST_MATRIX" | jq -c .)" >> "$GITHUB_OUTPUT"
            echo "üß™ Test mode - hardcoded connector changes for testing"
            exit 0
          fi

          # For push events, always run in test mode for now
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "changed_connectors=test-commit-$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_OUTPUT"

            # Create test matrix for commit-based testing
            TEST_MATRIX='[
              {"namespace": "hasura", "connector_name": "postgres", "connector_version": "v3.1.0"},
              {"namespace": "hasura", "connector_name": "snowflake-jdbc", "connector_version": "v1.2.12"}
            ]'
            echo "connector_matrix=$(echo "$TEST_MATRIX" | jq -c .)" >> "$GITHUB_OUTPUT"
            echo "üß™ Commit test mode - building DDN workspace for commit ${{ github.sha }}"
            exit 0
          fi

          # Read changed files from the JSON file created by tj-actions/changed-files
          if [ -f "changed_files.json" ]; then
            echo "üìÑ Reading changed files from changed_files.json"
            cat changed_files.json

            # Extract all changed files in registry/ or ddn-workspace/ directory
            CHANGED_FILES=$(jq -r '.added_files[], .modified_files[], .deleted_files[]' changed_files.json 2>/dev/null | grep -E '^(registry/|ddn-workspace/)' || true)

            echo "Changed files in registry/ or ddn-workspace/:"
            echo "$CHANGED_FILES"

            # Check if any files changed
            if [ -n "$CHANGED_FILES" ]; then
              echo "should_build=true" >> "$GITHUB_OUTPUT"

              # Extract unique connector paths (registry/namespace/connector-name)
              CHANGED_CONNECTORS=$(echo "$CHANGED_FILES" | \
                grep -E '^registry/[^/]+/[^/]+/' | \
                sed 's|^registry/\([^/]*\)/\([^/]*\)/.*|\1/\2|' | \
                sort -u)

              echo "Changed connectors:"
              echo "$CHANGED_CONNECTORS"

              # Build matrix JSON from changed connectors
              MATRIX_JSON="[]"
              while IFS= read -r connector_path; do
                if [ -n "$connector_path" ]; then
                  namespace=$(echo "$connector_path" | cut -d'/' -f1)
                  connector_name=$(echo "$connector_path" | cut -d'/' -f2)

                  # Get the latest version from releases directory
                  latest_version=$(ls "registry/$connector_path/releases/" 2>/dev/null | grep -E '^v[0-9]' | sort -V | tail -1)

                  if [ -n "$latest_version" ]; then
                    echo "Adding $namespace/$connector_name:$latest_version to matrix"
                    MATRIX_JSON=$(echo "$MATRIX_JSON" | jq --arg ns "$namespace" --arg name "$connector_name" --arg ver "$latest_version" \
                      '. += [{"namespace": $ns, "connector_name": $name, "connector_version": $ver}]')
                  fi
                fi
              done <<< "$CHANGED_CONNECTORS"

              # Convert connector matrix to comma-separated list for display
              CONNECTOR_LIST=$(echo "$MATRIX_JSON" | jq -r '.[] | "\(.namespace)/\(.connector_name):\(.connector_version)"' | tr '\n' ',' | sed 's/,$//')

              echo "changed_connectors=${CONNECTOR_LIST}" >> "$GITHUB_OUTPUT"
              echo "connector_matrix=$(echo "$MATRIX_JSON" | jq -c .)" >> "$GITHUB_OUTPUT"

              echo "üîç Detected changes requiring build: $CONNECTOR_LIST"
            else
              echo "should_build=false" >> "$GITHUB_OUTPUT"
              echo "changed_connectors=" >> "$GITHUB_OUTPUT"
              echo "connector_matrix=[]" >> "$GITHUB_OUTPUT"
              echo "‚ÑπÔ∏è No connector or DDN workspace changes detected"
            fi
          else
            echo "‚ö†Ô∏è changed_files.json not found"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            echo "changed_connectors=" >> "$GITHUB_OUTPUT"
            echo "connector_matrix=[]" >> "$GITHUB_OUTPUT"
          fi

  build-and-push-ddn-workspace:
    needs: detect-connector-changes
    runs-on: ubuntu-latest
    if: needs.detect-connector-changes.outputs.should_build == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # - name: Setup gcloud
      #   env:
      #     GCLOUD_EE_AUTH: ${{ secrets.GCLOUD_EE_AUTH }}
      #   run: |
      #     echo "$GCLOUD_EE_AUTH" | base64 -d > "$HOME"/gcloud.json
      #     gcloud auth activate-service-account --key-file=$HOME/gcloud.json
      #     gcloud auth configure-docker -q
      #     echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud.json" >> $GITHUB_ENV

      - name: Reconstruct connector-versions.json with latest DDN-enabled connectors
        run: |
          set -e

          echo "üîÑ Reconstructing connector-versions.json with latest versions of DDN-enabled connectors"

          # Initialize JSON object
          echo "{}" > ddn-workspace/connector-versions.json

          # Iterate through registry to find connectors with DDN workspace enabled
          for namespace_dir in registry/*/; do
            if [ -d "$namespace_dir" ]; then
              namespace=$(basename "$namespace_dir")
              echo "ÔøΩ Scanning namespace: $namespace"

              for connector_dir in "$namespace_dir"*/; do
                if [ -d "$connector_dir" ]; then
                  connector_name=$(basename "$connector_dir")
                  test_config="$connector_dir/tests/test-config.json"

                  # Check if test-config.json exists and has DDN workspace enabled
                  if [ -f "$test_config" ]; then
                    DDN_ENABLED=$(jq -r '.ddn_workspace.enabled // false' "$test_config" 2>/dev/null)

                    if [ "$DDN_ENABLED" = "true" ]; then
                      echo "  ‚úÖ Found DDN-enabled connector: $namespace/$connector_name"

                      # Find the latest version from releases directory
                      releases_dir="$connector_dir/releases"
                      if [ -d "$releases_dir" ]; then
                        latest_version=$(ls "$releases_dir" 2>/dev/null | grep -E '^v[0-9]' | sort -V | tail -1)

                        if [ -n "$latest_version" ]; then
                          echo "    üì¶ Latest version: $latest_version"

                          # Create connector key in format "namespace/connector_name"
                          connector_key="$namespace/$connector_name"

                          # Add to connector-versions.json in key-value format
                          jq --arg key "$connector_key" --arg version "$latest_version" \
                            '. + {($key): $version}' \
                            ddn-workspace/connector-versions.json > tmp.json
                          mv tmp.json ddn-workspace/connector-versions.json
                        else
                          echo "    ‚ö†Ô∏è No versions found in releases directory"
                        fi
                      else
                        echo "    ‚ö†Ô∏è No releases directory found"
                      fi
                    fi
                  fi
                fi
              done
            fi
          done

          echo "üìã Generated connector-versions.json:"
          cat ddn-workspace/connector-versions.json | jq .

          # Count DDN-enabled connectors
          DDN_CONNECTOR_COUNT=$(cat ddn-workspace/connector-versions.json | jq 'length')
          echo "‚úÖ Found $DDN_CONNECTOR_COUNT connectors with DDN workspace enabled"

      - name: Generate build metadata
        id: meta
        run: |
          # Generate timestamp-based tag
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          echo "timestamp=${TIMESTAMP}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "version_tag=${TIMESTAMP}-${COMMIT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Build DDN Workspace image
        timeout-minutes: 45
        run: |
          set -e

          echo "üöÄ Building DDN Workspace image with ALL DDN-enabled connectors"
          echo "ÔøΩ Trigger: ${{ needs.detect-connector-changes.outputs.changed_connectors }}"
          echo "üìã This image will include the latest versions of ALL connectors with ddn_workspace enabled"

          # Check if connector versions file exists and has content
          if [ -f "ddn-workspace/connector-versions.json" ] && [ "$(jq 'keys | length' ddn-workspace/connector-versions.json)" -gt 0 ]; then
            echo "üìÑ Using generated connector versions file:"
            cat ddn-workspace/connector-versions.json

            # Use the build script to build with custom versions
            # Use production environment for main branch builds
            DDN_ENV="production"

            cd ddn-workspace
            chmod +x scripts/build-with-versions.sh
            ./scripts/build-with-versions.sh connector-versions.json ddn-native-workspace:${{ steps.meta.outputs.version_tag }} $DDN_ENV
            cd ..
          else
            echo "‚ö†Ô∏è No connector versions file found, building with defaults..."
          fi

          echo "‚úÖ DDN Workspace image built successfully with all DDN-enabled connectors"

      - name: Save DDN Workspace image as artifact
        run: |
          set -e

          echo "üì¶ Saving DDN Workspace image as artifact"

          # Save the image to a tar file
          docker save ddn-native-workspace:${{ steps.meta.outputs.version_tag }} | gzip > ddn-workspace-${{ steps.meta.outputs.version_tag }}.tar.gz

          echo "‚úÖ DDN Workspace image saved successfully!"
          echo ""
          echo "üì¶ Saved image:"
          echo "  üè∑Ô∏è  ddn-native-workspace:${{ steps.meta.outputs.version_tag }}"
          echo "  üìÅ  ddn-workspace-${{ steps.meta.outputs.version_tag }}.tar.gz"
          echo ""
          echo "üîç Changed connectors: ${{ needs.detect-connector-changes.outputs.changed_connectors }}"

      - name: Upload DDN Workspace image artifact
        uses: actions/upload-artifact@v4
        with:
          name: ddn-workspace-image-${{ steps.meta.outputs.version_tag }}
          path: ddn-workspace-${{ steps.meta.outputs.version_tag }}.tar.gz
          retention-days: 7

      - name: Send Slack notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#ddn-workspace-releases'
          text: |
            üß™ *DDN Workspace Build Test Complete*

            üì¶ *Test Image Built:*
            `ddn-native-workspace:${{ steps.meta.outputs.version_tag }}`

            üîç *Test Connectors:* ${{ needs.detect-connector-changes.outputs.changed_connectors }}

            üìã *Build Info:*
            ‚Ä¢ Branch: ${{ github.ref_name }}
            ‚Ä¢ Commit: ${{ github.sha }}
            ‚Ä¢ Event: ${{ github.event_name }}
            ‚Ä¢ Mode: Test (artifact upload)

            üìÅ *Artifact:* `ddn-workspace-image-${{ steps.meta.outputs.version_tag }}`

            üéØ *Next Steps:*
            Download the artifact from GitHub Actions to test the image locally.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create release summary
        run: |
          # Parse connector matrix to create a nice list
          CONNECTOR_MATRIX='${{ needs.detect-connector-changes.outputs.connector_matrix }}'
          CONNECTOR_LIST=""

          if [ "$CONNECTOR_MATRIX" != "[]" ] && [ -n "$CONNECTOR_MATRIX" ]; then
            CONNECTOR_LIST=$(echo "$CONNECTOR_MATRIX" | jq -r '.[] | "- `\(.namespace)/\(.connector_name):\(.connector_version)`"' | tr '\n' '\n')
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üß™ DDN Workspace Build Test Complete

          ## üì¶ Test Image Built
          - \`ddn-native-workspace:${{ steps.meta.outputs.version_tag }}\`

          ## üìÅ Artifact Available
          - \`ddn-workspace-image-${{ steps.meta.outputs.version_tag }}\`

          ## üîç Build Information
          - **Event**: ${{ github.event_name }}
          - **Branch**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Triggered by**: ${{ needs.detect-connector-changes.outputs.changed_connectors }}

          ## üìã Build Scope
          This image contains **ALL connectors with \`ddn_workspace\` enabled**, not just the changed ones.

          ### Changed Connectors (Trigger)
          ${CONNECTOR_LIST:-"No specific connectors detected (force build or DDN workspace changes)"}

          ### Image Contents
          The built image includes the latest versions of ALL connectors that have \`ddn_workspace: {\"enabled\": true}\` in their test configuration.

          ## üéØ Test Usage
          1. Download the artifact from this workflow run
          2. Load the image locally:
          \`\`\`bash
          gunzip -c ddn-workspace-${{ steps.meta.outputs.version_tag }}.tar.gz | docker load
          \`\`\`
          3. Run the image:
          \`\`\`bash
          docker run -it ddn-native-workspace:${{ steps.meta.outputs.version_tag }}
          \`\`\`
          EOF
